#!/bin/bash
# Pre-commit hook: Auto-fix version mismatch between plugin.yaml and plugin.json
#
# Activate with: git config core.hooksPath .githooks
#
# Behavior: If versions differ, the higher version wins and the other file is updated.

FIXED=0

# Compare semver: returns 0 if $1 > $2, 1 otherwise
semver_gt() {
    [ "$(printf '%s\n%s' "$1" "$2" | sort -V | tail -n1)" = "$1" ] && [ "$1" != "$2" ]
}

for plugin in plugins/*/; do
    [ -d "$plugin" ] || continue

    name=$(basename "$plugin")
    yaml_file="$plugin/plugin.yaml"
    json_file="$plugin/.claude-plugin/plugin.json"

    # Skip if either file missing
    [ -f "$yaml_file" ] || continue
    [ -f "$json_file" ] || continue

    yaml_ver=$(grep "^version:" "$yaml_file" 2>/dev/null | sed 's/version: *//')
    json_ver=$(jq -r '.version // empty' "$json_file" 2>/dev/null)

    # Skip if versions match or either is empty
    [ -z "$yaml_ver" ] || [ -z "$json_ver" ] && continue
    [ "$yaml_ver" = "$json_ver" ] && continue

    # Determine higher version
    if semver_gt "$yaml_ver" "$json_ver"; then
        higher="$yaml_ver"
        # Update json
        jq --arg v "$higher" '.version = $v' "$json_file" > "$json_file.tmp" && mv "$json_file.tmp" "$json_file"
        echo "FIXED: $name -> $higher (updated plugin.json)"
    else
        higher="$json_ver"
        # Update yaml
        sed -i "s/^version: .*/version: $higher/" "$yaml_file"
        echo "FIXED: $name -> $higher (updated plugin.yaml)"
    fi

    # Stage the fixed file
    git add "$yaml_file" "$json_file"
    FIXED=$((FIXED + 1))
done

if [ $FIXED -gt 0 ]; then
    echo ""
    echo "Auto-fixed $FIXED version mismatch(es). Files staged."
fi

exit 0
